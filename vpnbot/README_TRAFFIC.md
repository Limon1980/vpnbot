# Система учета трафика для VPN бота

## Описание

Система автоматического учета трафика для OpenVPN клиентов, интегрированная с Telegram ботом.

## Компоненты системы

### 1. traffic_collector.php
**Основной скрипт сбора трафика**
- Парсит файл `/var/log/openvpn/status.log`
- Обновляет данные о трафике в базе данных
- Обрабатывает завершенные сессии
- Запускается каждую минуту через cron

### 2. traffic_stats.php
**Веб-интерфейс для мониторинга**
- Административная панель с статистикой
- Просмотр активных сессий
- Топ пользователей по трафику
- Общая статистика системы

### 3. Интеграция с ботом
**Отображение трафика в личном кабинете**
- Показ текущей сессии
- Общая статистика трафика
- Статус подключения

## Настройка

### 1. Настройка cron

Добавьте следующую строку в crontab:

```bash
# Открыть crontab для редактирования
crontab -e

# Добавить строку (замените путь на актуальный):
* * * * * /usr/bin/php /var/www/html/vpnbot/traffic_collector.php >/dev/null 2>&1
```

### 2. Настройка логирования

Убедитесь, что директория для логов доступна для записи:

```bash
sudo touch /var/log/vpnbot_traffic.log
sudo chown www-data:www-data /var/log/vpnbot_traffic.log
sudo chmod 644 /var/log/vpnbot_traffic.log
```

### 3. Настройка OpenVPN

Убедитесь, что OpenVPN записывает статус в нужный файл.

В конфигурации OpenVPN сервера должно быть:
```
status /var/log/openvpn/status.log 60
```

### 4. Права доступа

Убедитесь, что веб-сервер может читать лог OpenVPN:

```bash
sudo chgrp www-data /var/log/openvpn/status.log
sudo chmod 640 /var/log/openvpn/status.log
```

## Структура базы данных

Система использует следующие поля в таблице `vpnusers`:

- `recive_byte` - байты получены за текущую сессию
- `sent_byte` - байты отправлены за текущую сессию  
- `full_recive_byte` - общие полученные байты
- `full_sent_byte` - общие отправленные байты
- `session_start` - время начала текущей сессии

## Мониторинг

### Проверка работы cron
```bash
# Просмотр логов cron
grep CRON /var/log/syslog | tail -10

# Просмотр логов скрипта
tail -f /var/log/vpnbot_traffic.log
```

### Веб-интерфейс
Откройте в браузере: `https://ваш_домен/vpnbot/traffic_stats.php`

### Проверка данных в БД
```sql
SELECT chat_id, key_name, recive_byte, sent_byte, full_recive_byte, full_sent_byte, session_start 
FROM vpnusers 
WHERE key_name IS NOT NULL 
ORDER BY session_start DESC;
```

## Логика работы

### Активные сессии
1. Скрипт парсит `/var/log/openvpn/status.log`
2. Извлекает chat_id из имени клиента (формат: VpnOpenBot_chat_id)
3. Обновляет поля `recive_byte` и `sent_byte` для активных сессий
4. Устанавливает `session_start` если сессия только началась

### Завершенные сессии
1. Если клиент был активен в БД, но исчез из лога OpenVPN
2. Трафик текущей сессии добавляется к общим счетчикам
3. Поля текущей сессии обнуляются
4. `session_start` устанавливается в NULL

### Отображение в боте
В личном кабинете показывается:
- Статус текущей сессии (активна/не активна)
- Трафик текущей сессии (если активна)
- Общая статистика за все время

## Устранение неисправностей

### Скрипт не запускается
1. Проверьте права доступа к файлам
2. Проверьте путь к PHP в cron
3. Проверьте логи: `tail -f /var/log/vpnbot_traffic.log`

### Нет данных о трафике
1. Проверьте, что OpenVPN пишет в `/var/log/openvpn/status.log`
2. Убедитесь, что веб-сервер может читать этот файл
3. Проверьте формат имен клиентов (должно быть VpnOpenBot_chat_id)

### Неточные данные
1. OpenVPN обновляет статус каждую минуту
2. Cron также запускается каждую минуту
3. Небольшие расхождения в 1-2 минуты нормальны

## Дополнительные возможности

### Ограничение трафика
Можно добавить проверки лимитов в скрипт и автоматически блокировать пользователей:

```php
// Пример в traffic_collector.php
if ($totalTraffic > $userLimit) {
    // Заблокировать пользователя
    $this->blockUser($chatId);
}
```

### Уведомления
Можно настроить отправку уведомлений при превышении лимитов:

```php
// Пример отправки уведомления
if ($currentTotal > $warningLimit) {
    $this->sendTrafficWarning($chatId, $currentTotal);
}
```

### Экспорт данных
Через веб-интерфейс можно добавить экспорт статистики в CSV/Excel.