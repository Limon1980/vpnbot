# Система мониторинга сервера

## Описание

Добавлена система мониторинга сервера в админ панель VPN бота, которая отображает:
- Загрузку CPU
- Использование памяти и диска
- Статистику сетевых интерфейсов
- Load Average и время работы системы
- Количество процессов

## Файлы системы

### 1. `system_monitor.php`
Основной класс для сбора системной информации:
- Получение данных о CPU, памяти, диске
- Статистика сетевых интерфейсов
- Кеширование данных на 5 минут для экономии ресурсов
- Форматирование данных для отображения

### 2. `monitor_api.php`
API endpoint для получения данных мониторинга:
- JSON API для AJAX запросов
- Автоматическое форматирование данных
- Обработка ошибок

### 3. `traffic_stats.php` (обновлен)
Добавлен раздел "Мониторинг системы":
- Красивый веб-интерфейс с карточками
- Автообновление каждые 60 секунд
- Прогресс-бары с цветовой индикацией
- Адаптивная сетка

### 4. `test_monitor.php`
Тестовый скрипт для проверки работы мониторинга.

## Особенности

### Производительность
- **Кеширование**: Данные кешируются на 5 минут в `/tmp/vpn_system_monitor.json`
- **Минимальная нагрузка**: Измерение CPU занимает 1 секунду
- **Отложенное обновление**: Веб-интерфейс обновляется каждые 60 секунд

### Точность данных
- **CPU**: Измеряется через `/proc/stat` с резервным методом через `top`
- **Память**: Данные из `/proc/meminfo`
- **Диск**: Использует встроенные PHP функции `disk_total_space()`
- **Сеть**: Статистика из `/proc/net/dev` и `/sys/class/net/`

### Визуализация
- **Цветовая индикация**: Зеленый (<50%), желтый (50-80%), красный (>80%)
- **Прогресс-бары**: Визуальное отображение процентов использования
- **Адаптивный дизайн**: Автоматическое размещение карточек
- **Real-time обновления**: Без перезагрузки страницы

## Доступ к мониторингу

### Веб-интерфейс
```
https://ваш_домен/vpnbot/traffic_stats.php?action=monitor
```

### API
```
https://ваш_домен/vpnbot/monitor_api.php
```

Возвращает JSON с полными данными о системе.

## Пример данных API

```json
{
  "success": true,
  "data": {
    "timestamp": 1640995200,
    "cpu": 15.32,
    "memory": {
      "total": 8589934592,
      "used": 4294967296,
      "free": 4294967296,
      "percentage": 50.0,
      "total_formatted": "8 GB",
      "used_formatted": "4 GB",
      "free_formatted": "4 GB"
    },
    "disk": {
      "total": 107374182400,
      "used": 53687091200,
      "free": 53687091200,
      "percentage": 50.0,
      "total_formatted": "100 GB",
      "used_formatted": "50 GB",
      "free_formatted": "50 GB"
    },
    "network": {
      "eth0": {
        "rx_bytes": 1073741824,
        "tx_bytes": 536870912,
        "rx_packets": 1000000,
        "tx_packets": 800000,
        "rx_errors": 0,
        "tx_errors": 0,
        "speed": 1000,
        "is_up": true,
        "rx_bytes_formatted": "1 GB",
        "tx_bytes_formatted": "512 MB",
        "speed_formatted": "1000 Mbps"
      }
    },
    "load_average": {
      "1min": 1.25,
      "5min": 1.10,
      "15min": 0.95
    },
    "uptime": {
      "seconds": 259200,
      "formatted": "3 дня, 0 часов, 0 минут"
    },
    "processes": {
      "total": 150,
      "running": 120
    }
  },
  "colors": {
    "cpu": "#28a745",
    "memory": "#ffc107",
    "disk": "#28a745"
  },
  "last_update": "2024-01-01 12:00:00"
}
```

## Настройка и установка

### 1. Права доступа
Убедитесь, что веб-сервер может:
- Читать `/proc/stat`, `/proc/meminfo`, `/proc/loadavg`, `/proc/uptime`
- Читать `/proc/net/dev`
- Читать `/sys/class/net/*/speed` и `/sys/class/net/*/operstate`
- Писать в `/tmp/` для кеша

### 2. Тестирование
```bash
php test_monitor.php
```

### 3. Проверка веб-интерфейса
Откройте в браузере раздел "Мониторинг системы" в админ панели.

### 4. Настройка интервала обновления
В `traffic_stats.php` можно изменить интервал обновления:
```javascript
monitorInterval = setInterval(loadMonitorData, 60000); // 60 секунд
```

В `system_monitor.php` можно изменить время кеширования:
```php
private $cacheTime = 300; // 5 минут
```

## Мониторинг производительности

### Нагрузка на систему
- **CPU**: ~1% на измерение (1 секунда каждые 5 минут)
- **Память**: Минимальная (чтение файлов /proc)
- **Диск**: Одноразовый вызов `disk_*_space()`
- **Сеть**: Чтение файлов /proc и /sys

### Рекомендации
- При высокой нагрузке увеличьте время кеша до 10-15 минут
- На слабых серверах увеличьте интервал обновления веб-интерфейса
- Мониторьте размер кеш-файла в `/tmp/`

## Устранение неисправностей

### Нет данных о CPU
- Проверьте доступ к `/proc/stat`
- Убедитесь, что команда `top` доступна

### Нет данных о сети
- Проверьте права на чтение `/proc/net/dev`
- Убедитесь, что `/sys/class/net/` доступна

### Медленная работа
- Увеличьте время кеширования
- Проверьте производительность команды `ps aux`

### Ошибки в браузере
- Проверьте доступность `monitor_api.php`
- Убедитесь, что нет ошибок PHP в логах
- Проверьте права на запись в `/tmp/`