<?php
include('db.php');
$dbh = new Db();

$token = 'you_token';
function sendTm($token, $method, $request_params)
{
    // Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ URL-Ð°Ð´Ñ€ÐµÑÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
    $url = 'https://api.telegram.org/bot' . $token . '/' . $method;

    // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ cURL
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $request_params);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

    // ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð°
    $result = curl_exec($ch);
    curl_close($ch);

    // Ð”ÐµÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð° JSON
    $result = json_decode($result, true);

    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ñ‚Ð²ÐµÑ‚Ð°
    if ($result['ok']) {
        // Ð£ÑÐ¿ÐµÑˆÐ½Ð°Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
        echo 'Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾.' . PHP_EOL;
    } else {
        // ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
        echo 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ: ' . $result['description'] . PHP_EOL;
    }
}

try {
    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÐ¸, Ð³Ð´Ðµ day = 0 Ð¸ tarif = 'base'
    $result = $dbh->query("SELECT chat_id, ip, tarif FROM vpnusers WHERE day = 0 AND tarif = 'base'");
    
    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»Ðµ tarif Ð½Ð° 'block' Ð´Ð»Ñ ÑÑ‚Ñ€Ð¾Ðº Ñ day = 0 Ð¸ tarif = 'base'
    $dbh->query("UPDATE vpnusers SET tarif = 'block' WHERE day = 0 AND tarif = 'base'");
    
    // ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ°Ð¶Ð´ÑƒÑŽ ÑÑ‚Ñ€Ð¾ÐºÑƒ
    foreach ($result as $row) {
        $ip = $row['ip'];
		$chat_id = $row['chat_id'];
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ IP-Ð°Ð´Ñ€ÐµÑ Ð½Ðµ Ð¿ÑƒÑÑ‚Ð¾Ð¹
        if (!empty($ip)) {
            // Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° iptables
            $cmd = "sudo /usr/sbin/iptables -C FORWARD -s " . escapeshellarg($ip) . " -j DROP 2>/dev/null || sudo /usr/sbin/iptables -I FORWARD -s " . escapeshellarg($ip) . " -j DROP";
            exec($cmd, $output, $return_var);
            
            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
            if ($return_var !== 0) {
                error_log("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐµ IP $ip: " . implode(", ", $output));
            } else {
                error_log("Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½ IP $ip");
            }
			
			$request_params = [
					'chat_id'   => $chat_id,
					'text' => "\nðŸš« Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð°ÐºÑ€Ñ‹Ñ‚: Ð’Ð°Ñˆ Ñ‚Ð°Ñ€Ð¸Ñ„ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ð¿Ð»Ð°Ñ‚Ð¸Ñ‚Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ Ð´Ð»Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°.",
					// 'disable_notification' => 1,
					];

	
			sendTm($token, 'sendMessage', $request_params);	
        }
    }
    
    // Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹
    error_log("ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹: " . count($result));
    return $result;
} catch (Exception $e) {
    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±ÐºÐ¸
    error_log("ÐžÑˆÐ¸Ð±ÐºÐ°: " . $e->getMessage());
}
?>
